function u(e){return e>1e9?`${(e/1e9).toPrecision(3)} GB`:e>1e6?`${(e/1e6).toPrecision(3)} MB`:e>1e3?`${(e/1e3).toPrecision(3)} kB`:e!==1?`${e} bytes`:"1 byte"}function x(e){let t=e.lastIndexOf(".");return t===-1?e:e.slice(0,t)}var M=new TextEncoder;function y(e,t=""){return e.find(({type:o})=>o.startsWith(t))??e[0]}function I(e){return e.kind==="string"?new Promise(t=>e.getAsString(t)):Promise.resolve(e.getAsFile())}function h({fileName:e=null,input:t,dropTarget:o,pasteTarget:a,preferredType:r,onFile:i}){async function c(n){if(n===null||(n instanceof DataTransfer?n.items:n).length===0)return;let d=n instanceof DataTransfer?await I(y(Array.from(n.items),r)):y(Array.from(n),r);if(d===null)return;let g=d instanceof File?`${d.name} \xB7 ${u(d.size)}`:`Plain text \xB7 ${u(M.encode(d).length)}`;try{(await i(d)??!0)&&e&&(e.textContent=g,e.classList.remove("file-error"))}catch(s){throw e&&(e.textContent=g+" \u2014 failed to load",e.classList.add("file-error")),s}}if(t?.addEventListener("change",()=>{c(t.files),t.value=""}),t?.dataset.default){let n=t.dataset.default,d=n.slice(n.lastIndexOf("/")+1);fetch(n).then(g=>g.blob()).catch(g=>{throw e&&(e.textContent=d+" \u2014 failed to load",e.classList.add("file-error")),g}).then(g=>c([new File([g],d,g)]))}o?.addEventListener("drop",async n=>{c(n.dataTransfer),o.classList.remove("drag-over"),n.preventDefault()}),o?.addEventListener("dragover",n=>{o.classList.add("drag-over"),n.preventDefault()}),o?.addEventListener("dragleave",()=>{o.classList.remove("drag-over")}),a&&document.addEventListener("paste",n=>{n.target instanceof HTMLTextAreaElement||n.target instanceof HTMLInputElement||c(n.clipboardData)})}function k(e,t){let o=t?.closest(".reform\\:io");t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let a=o?.querySelector(".input-controls");h({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:a instanceof HTMLElement?a:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async r=>{e.handleValue(r instanceof File?r:new File([r],"text.txt",{type:"text/plain"}))}})}function E(e,t){t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let o=t?.closest(".reform\\:io"),a=o?.querySelector(".input-content canvas");a&&!(a instanceof HTMLCanvasElement)&&(console.warn(a,"is not a <canvas> element"),a=null);let r=a??document.createElement("canvas"),i=r.getContext("2d",{willReadFrequently:!!r.dataset.willReadFrequently});if(!i)throw new TypeError("Failed to get canvas context for the image input preview.");h({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:o instanceof HTMLElement?o:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),preferredType:"image/",onFile:async c=>{if(typeof c=="string")return!1;let n=URL.createObjectURL(c);try{let d=document.createElement("img");d.src=n,await new Promise((g,s)=>{d.addEventListener("load",g),d.addEventListener("error",s)}),r.dataset.name=x(c.name),r.width=d.width,r.height=d.height,i.drawImage(d,0,0),e.handleValue(i)}finally{URL.revokeObjectURL(n)}}})}function C(e,t){t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let o=t?.closest(".reform\\:io"),a=o?.querySelector(".input-content video");a&&!(a instanceof HTMLVideoElement)&&(console.warn(a,"is not a <video> element"),a=null);let r=a??document.createElement("video"),i;h({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:o instanceof HTMLElement?o:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),preferredType:"video/",onFile:async c=>{if(typeof c=="string")return!1;i&&URL.revokeObjectURL(i),i=URL.createObjectURL(c),r.src=i,r.dataset.name=x(c.name),await new Promise((n,d)=>{r.onloadeddata=()=>{r.readyState<2||n()},r.onerror=d}),e.handleValue(r)}})}function L(e,t){let o=t?.closest(".reform\\:io");t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let a=o?.querySelector(".input-controls"),r=o?.querySelector(".input-content");h({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:a instanceof HTMLElement?a:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),preferredType:"text/",onFile:async i=>{let c=i instanceof File?await i.text():i;r instanceof HTMLTextAreaElement&&(r.value=c),e.handleValue(c)}})}var f=class e{#e=null;#t=null;#r;#o;constructor({fileName:t=null,downloadLink:o=null,copyButton:a,shareButton:r}){this.#r=t,this.#o=o,a?.addEventListener("click",()=>{this.#e&&navigator.clipboard.write([new ClipboardItem({[this.#e.type]:this.#e})])}),r?.addEventListener("click",async()=>{this.#e&&(this.#e.type==="text/plain"&&this.#e.size<4e3?navigator.share({text:await this.#e.text()}):navigator.share({files:[this.#e]}))})}handleFile(t){this.#e=t,this.#r&&(this.#r.textContent=`${t.name} \xB7 ${u(t.size)}`),this.#o&&(this.#t&&URL.revokeObjectURL(this.#t),this.#t=URL.createObjectURL(t),this.#o.href=this.#t,this.#o.download=t.name)}static fromOutputControls(t){let o=t?.querySelector(".download");return o&&!(o instanceof HTMLAnchorElement)&&(console.warn(o,"is not an <a> element"),o=null),new e({fileName:t?.querySelector(".file-name"),downloadLink:o,copyButton:t?.querySelector(".icon-copy"),shareButton:t?.querySelector(".icon-share")})}};var p=class{lastValue;dependents=[];handleValue(t){this.lastValue=t;for(let o of this.dependents)o(t)}};var l={};function w(e){if(!(e instanceof HTMLElement&&e.dataset.ignore))if(e instanceof HTMLInputElement)if(l[e.name]??=new p,e.type==="number"||e.type==="range"||e.inputMode==="numeric"){if(e.value==="")return;l[e.name].handleValue(+e.value);let t=e.closest(".range-wrapper");if(t){let o=e;if(e.type==="range"){let r=t.lastElementChild;r instanceof HTMLInputElement&&(r.value=e.step==="any"||e.step&&+e.step<.1?(+e.value).toFixed(2):e.value)}else{let r=t.querySelector('[type="range"]');if(r instanceof HTMLInputElement)o=r;else return;o.value=e.value}let a=(+e.value-+o.min)/(+o.max-+o.min);o.style.setProperty("--progress",`${a*100}%`)}}else e.type==="checkbox"?l[e.name].handleValue(e.checked):e.type==="file"?e.files&&e.files.length>0&&l[e.name].handleValue(Array.from(e.files)):e.type==="radio"?e.checked&&l[e.name].handleValue(e.value):l[e.name].handleValue(e.value);else(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(l[e.name]??=new p,l[e.name].handleValue(e.value))}for(let e of document.getElementsByClassName("reform:image-input"))e instanceof HTMLInputElement&&(l[e.name]??=new p,E(l[e.name],e));for(let e of document.getElementsByClassName("reform:video-input"))e instanceof HTMLInputElement&&(l[e.name]??=new p,C(l[e.name],e));for(let e of document.getElementsByClassName("reform:text-input"))e instanceof HTMLInputElement&&(l[e.name]??=new p,L(l[e.name],e));for(let e of document.getElementsByClassName("reform:file-input"))e instanceof HTMLInputElement&&(l[e.name]??=new p,k(l[e.name],e));for(let e of document.forms)for(let t of e.elements)w(t);document.addEventListener("input",e=>w(e.target));document.addEventListener("change",e=>w(e.target));var v={};function T(e){let t=typeof e=="string"?e:e.name;if(!v[t]){let o=document.getElementById(t);if(!o){let i=document.getElementsByName(t);i.length>1&&console.warn("More than one element with name",t,Array.from(i)),o=i[0]??null}let a=o instanceof HTMLCanvasElement?o.getContext("2d"):o,r=typeof e!="string"&&e.deps||o?.dataset.deps?.split(" ")||[];v[t]={name:t,element:o,object:a,deps:r.map(i=>i.startsWith("&")?{name:i.slice(1),reference:!0}:{name:i,reference:!1})}}return v[t]}function P(e,t){let{name:o,element:a,object:r,deps:i}=T(e);l[o]??=new p;let c={callback:s=>{l[o].handleValue(s)}},n=a?.closest(".reform\\:io")?.querySelector(".output-controls");if(n){let s=f.fromOutputControls(n);l[o].dependents.push(b=>s.handleFile(b))}let d=async()=>{if(g.size===i.length){let s=await t(r,c);s!==void 0&&l[o].handleValue(s)}},g=new Set;for(let{name:s,reference:b}of i)if(b){let{object:m}=T(s);c[s]=m,g.add(s)}else l[s]??=new p,l[s].lastValue!==void 0&&(c[s]=l[s].lastValue,g.add(s)),l[s].dependents.push(m=>{c[s]=m,g.add(s),d()});d()}export{P as on};
