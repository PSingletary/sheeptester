var w=0,h,b;function C(e){if(!b||!h){h=Object.assign(document.createElement("a"),{className:"error-count",href:"#errors"});let t=Object.assign(document.createElement("h2"),{className:"error-count-wrapper"});t.append(h);let r=Object.assign(document.createElement("p"),{className:"error-note",textContent:"It could be due to a bug, or your input is not the correct format. If you'd like to report the error, please send me the entire error log below."});b=Object.assign(document.createElement("pre"),{className:"error-log"});let n=Object.assign(document.createElement("div"),{className:"error-wrapper",id:"errors"});n.append(r,b),document.body.append(t,n)}b.append(e,`
`),w++,h.textContent=`${w} error${w===1?"":"s"} occurred`}window.onerror=(e,t,r,n,o)=>{C(o?.stack?`Uncaught ${o.stack}`:`Uncaught ${o?.name??String(o)}: ${e} at ${t}:${r}${n!==void 0?":"+n:""}`)};window.addEventListener("unhandledrejection",e=>{C(e.reason?.stack?`Uncaught (in promise) ${e.reason.stack}`:e.reason instanceof Error?`Uncaught (in promise) ${e.reason.constructor.name}: ${e.reason.message}`:String(e.reason))});function u(e){return e>1e9?`${(e/1e9).toPrecision(3)} GB`:e>1e6?`${(e/1e6).toPrecision(3)} MB`:e>1e3?`${(e/1e3).toPrecision(3)} kB`:e!==1?`${e} bytes`:"1 byte"}function y(e){let t=e.lastIndexOf(".");return t===-1?e:e.slice(0,t)}var S=new TextEncoder;function L(e,t=[]){return e.find(({type:r})=>t.some(n=>r.startsWith(n)))??e[0]}function B(e){return e.kind==="string"?new Promise(t=>e.getAsString(t)):Promise.resolve(e.getAsFile())}function m({fileName:e=null,input:t,dropTarget:r,pasteTarget:n,onFile:o}){let i=t?.accept.replaceAll("*","").split(",")??[];async function d(a){if(a===null||(a instanceof DataTransfer?a.items:a).length===0)return;let c=a instanceof DataTransfer?await B(L(Array.from(a.items),i)):L(Array.from(a),i);if(c===null)return;let p=c instanceof File?`${c.name} \xB7 ${u(c.size)}`:`Plain text \xB7 ${u(S.encode(c).length)}`;try{(await o(c)??!0)&&e&&(e.textContent=p,e.classList.remove("file-error"))}catch(s){throw e&&(e.textContent=p+" \u2014 failed to load",e.classList.add("file-error")),s}}if(t?.addEventListener("change",()=>{d(t.files),t.value=""}),t?.dataset.default){let a=t.dataset.default,c=a.slice(a.lastIndexOf("/")+1);fetch(a).then(p=>p.blob()).catch(p=>{throw e&&(e.textContent=c+" \u2014 failed to load",e.classList.add("file-error")),p}).then(p=>d([new File([p],c,p)]))}r?.addEventListener("drop",async a=>{d(a.dataTransfer),r.classList.remove("drag-over"),a.preventDefault()}),r?.addEventListener("dragover",a=>{r.classList.add("drag-over"),a.preventDefault()}),r?.addEventListener("dragleave",()=>{r.classList.remove("drag-over")}),n&&document.addEventListener("paste",a=>{(a.target instanceof HTMLTextAreaElement||a.target instanceof HTMLInputElement)&&!a.target.readOnly&&!a.target.disabled||d(a.clipboardData)})}function T(e,t){let r=t?.closest(".reform\\:io");t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let n=r?.querySelector(".input-controls");m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:n instanceof HTMLElement?n:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async o=>{e.handleValue(o instanceof File?o:new File([o],"text.txt",{type:"text/plain"}))}})}function M(e,t){t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let r=t?.closest(".reform\\:io"),n=r?.querySelector(".input-content canvas");n&&!(n instanceof HTMLCanvasElement)&&(console.warn(n,"is not a <canvas> element"),n=null);let o=n??document.createElement("canvas"),i=o.getContext("2d",{willReadFrequently:!!o.dataset.willReadFrequently});if(!i)throw new TypeError("Failed to get canvas context for the image input preview.");m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:r instanceof HTMLElement?r:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async d=>{if(typeof d=="string")return!1;let a=URL.createObjectURL(d);try{let c=document.createElement("img");c.src=a,await new Promise((p,s)=>{c.addEventListener("load",p),c.addEventListener("error",()=>s(new TypeError(`Could not load '${d.name}' as image.`)))}),o.dataset.name=y(d.name),o.width=c.width,o.height=c.height,i.drawImage(c,0,0),e.handleValue(i)}finally{URL.revokeObjectURL(a)}}})}function I(e,t){t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let r=t?.closest(".reform\\:io"),n=r?.querySelector(".input-content video");n&&!(n instanceof HTMLVideoElement)&&(console.warn(n,"is not a <video> element"),n=null);let o=n??document.createElement("video"),i;m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:r instanceof HTMLElement?r:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async d=>{if(typeof d=="string")return!1;i&&URL.revokeObjectURL(i),i=URL.createObjectURL(d),o.src=i,o.dataset.name=y(d.name),await new Promise((a,c)=>{o.onloadeddata=()=>{o.readyState<2||a()},o.onerror=()=>c(new TypeError(`Could not load '${d.name}' as video.`))}),e.handleValue(o)}})}function j(e,t){let r=t?.closest(".reform\\:io");t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let n=r?.querySelector(".input-controls"),o=r?.querySelector(".input-content");m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:n instanceof HTMLElement?n:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async i=>{let d=i instanceof File?await i.text():i;o instanceof HTMLTextAreaElement&&(o.value=d),e.handleValue(d)}})}var f=class e{#e=null;#t=null;#o;#r;constructor({fileName:t=null,downloadLink:r=null,copyButton:n,shareButton:o}){this.#o=t,this.#r=r,n?.addEventListener("click",()=>{this.#e&&navigator.clipboard.write([new ClipboardItem({[this.#e.type]:this.#e})])}),o?.addEventListener("click",async()=>{this.#e&&(this.#e.type==="text/plain"&&this.#e.size<4e3?navigator.share({text:await this.#e.text()}):navigator.share({files:[this.#e]}))})}handleFile(t){this.#e=t,this.#o&&(this.#o.textContent=`${t.name} \xB7 ${u(t.size)}`),this.#r&&(this.#t&&URL.revokeObjectURL(this.#t),this.#t=URL.createObjectURL(t),this.#r.href=this.#t,this.#r.download=t.name)}static fromOutputControls(t){let r=t?.querySelector(".download");return r&&!(r instanceof HTMLAnchorElement)&&(console.warn(r,"is not an <a> element"),r=null),new e({fileName:t?.querySelector(".file-name"),downloadLink:r,copyButton:t?.querySelector("button.icon-copy, .reform\\:copy"),shareButton:t?.querySelector("button.icon-share")})}};var g=class{lastValue;dependents=[];handleValue(t){this.lastValue=t;for(let r of this.dependents)r(t)}};var l={};function E(e){if(!(e instanceof HTMLElement&&e.dataset.ignore))if(e instanceof HTMLInputElement)if(l[e.name]??=new g,e.type==="number"||e.type==="range"||e.inputMode==="numeric"){if(e.value==="")return;l[e.name].handleValue(+e.value);let t=e.closest(".range-wrapper");if(t){let r=e;if(e.type==="range"){let o=t.lastElementChild;o instanceof HTMLInputElement&&(o.value=e.step==="any"||e.step&&+e.step<.1?(+e.value).toFixed(2):e.value)}else{let o=t.querySelector('[type="range"]');if(o instanceof HTMLInputElement)r=o;else return;r.value=e.value}let n=(+e.value-+r.min)/(+r.max-+r.min);r.style.setProperty("--progress",`${n*100}%`)}}else e.type==="checkbox"?l[e.name].handleValue(e.checked):e.type==="file"?e.files&&e.files.length>0&&l[e.name].handleValue(Array.from(e.files)):e.type==="radio"?e.checked&&l[e.name].handleValue(e.value):l[e.name].handleValue(e.value);else(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(l[e.name]??=new g,l[e.name].handleValue(e.value))}for(let e of document.getElementsByClassName("reform:image-input"))e instanceof HTMLInputElement&&(l[e.name]??=new g,M(l[e.name],e));for(let e of document.getElementsByClassName("reform:video-input"))e instanceof HTMLInputElement&&(l[e.name]??=new g,I(l[e.name],e));for(let e of document.getElementsByClassName("reform:text-input"))e instanceof HTMLInputElement&&(l[e.name]??=new g,j(l[e.name],e));for(let e of document.getElementsByClassName("reform:file-input"))e instanceof HTMLInputElement&&(l[e.name]??=new g,T(l[e.name],e));for(let e of document.forms)for(let t of e.elements)E(t);document.addEventListener("input",e=>E(e.target));document.addEventListener("change",e=>E(e.target));var k={};function H(e){let t=typeof e=="string"?e:e.name;if(!k[t]){let r=document.getElementById(t);if(!r){let i=document.getElementsByName(t);i.length>1&&console.warn("More than one element with name",t,Array.from(i)),r=i[0]??null}let n=r instanceof HTMLCanvasElement?r.getContext("2d"):r,o=typeof e!="string"&&e.deps||r?.dataset.deps?.split(" ")||[];k[t]={name:t,element:r,object:n,deps:o.map(i=>i.startsWith("&")?{name:i.slice(1),reference:!0}:{name:i,reference:!1})}}return k[t]}function W(e,t){let{name:r,element:n,object:o,deps:i}=H(e);l[r]??=new g;let d={callback:s=>{l[r].handleValue(s)}},a=n?.closest(".reform\\:io")?.querySelector(".output-controls");if(a){let s=f.fromOutputControls(a);l[r].dependents.push(x=>s.handleFile(x))}let c=async()=>{if(p.size===i.length){let s=await t(o,d);s!==void 0&&l[r].handleValue(s)}},p=new Set;for(let{name:s,reference:x}of i)if(x){let{object:v}=H(s);d[s]=v,p.add(s)}else l[s]??=new g,l[s].lastValue!==void 0&&(d[s]=l[s].lastValue,p.add(s)),l[s].dependents.push(v=>{d[s]=v,p.add(s),c()});c()}export{W as on};
