function u(e){return e>1e9?`${(e/1e9).toPrecision(3)} GB`:e>1e6?`${(e/1e6).toPrecision(3)} MB`:e>1e3?`${(e/1e3).toPrecision(3)} kB`:e!==1?`${e} bytes`:"1 byte"}function b(e){let t=e.lastIndexOf(".");return t===-1?e:e.slice(0,t)}var E=new TextEncoder;function m({fileName:e=null,input:t,dropTarget:o,pasteTarget:r,onFile:a}){async function s(n){if(n===null||(n instanceof FileList?n:n.items).length===0)return;let d=n instanceof FileList?n[0]:n.items[0].kind==="string"?await new Promise(g=>n.items[0].getAsString(g)):n.items[0].getAsFile();if(d===null)return;let c=d instanceof File?`${d.name} \xB7 ${u(d.size)}`:`Plain text \xB7 ${u(E.encode(d).length)}`;try{(await a(d)??!0)&&e&&(e.textContent=c,e.classList.remove("file-error"))}catch(g){console.error(g),e&&(e.textContent=c+" \u2014 failed to load",e.classList.add("file-error"))}}t?.addEventListener("change",()=>{s(t.files),t.value=""}),o?.addEventListener("drop",async n=>{s(n.dataTransfer),o.classList.remove("drag-over"),n.preventDefault()}),o?.addEventListener("dragover",n=>{o.classList.add("drag-over"),n.preventDefault()}),o?.addEventListener("dragleave",()=>{o.classList.remove("drag-over")}),r&&document.addEventListener("paste",n=>{n.target instanceof HTMLTextAreaElement||n.target instanceof HTMLInputElement||s(n.clipboardData)})}function v(e,t){let o=t?.closest(".reform\\:io");t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let r=o?.querySelector(".input-controls");m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:r instanceof HTMLElement?r:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async a=>{e.handleValue(a instanceof File?a:new File([a],"text.txt",{type:"text/plain"}))}})}function w(e,t){t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let o=t?.closest(".reform\\:io"),r=o?.querySelector(".input-content canvas");r&&!(r instanceof HTMLCanvasElement)&&(console.warn(r,"is not a <canvas> element"),r=null);let a=r??document.createElement("canvas"),s=a.getContext("2d");m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:o instanceof HTMLElement?o:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async n=>{if(typeof n=="string")return!1;let d=URL.createObjectURL(n);try{let c=document.createElement("img");c.src=d,await new Promise((g,l)=>{c.addEventListener("load",g),c.addEventListener("error",l)}),a.dataset.name=b(n.name),a.width=c.width,a.height=c.height,s?.drawImage(c,0,0),e.handleValue(a)}finally{URL.revokeObjectURL(d)}}})}function k(e,t){let o=t?.closest(".reform\\:io");t&&!(t instanceof HTMLInputElement)?(console.warn(t,"is not an <input> element"),t=null):t&&(t.dataset.ignore="true");let r=o?.querySelector(".input-controls"),a=o?.querySelector(".input-content");m({fileName:t?.parentElement?.querySelector(".file-name"),input:t,dropTarget:r instanceof HTMLElement?r:void 0,pasteTarget:t?.classList.contains("reform:paste-target"),onFile:async s=>{let n=s instanceof File?await s.text():s;a instanceof HTMLTextAreaElement&&(a.value=n),e.handleValue(n)}})}var h=class e{#e=null;#t=null;#n;#o;constructor({fileName:t=null,downloadLink:o=null,copyButton:r,shareButton:a}){this.#n=t,this.#o=o,r?.addEventListener("click",()=>{this.#e&&navigator.clipboard.write([new ClipboardItem({[this.#e.type]:this.#e})])}),a?.addEventListener("click",async()=>{this.#e&&(this.#e.type==="text/plain"&&this.#e.size<4e3?navigator.share({text:await this.#e.text()}):navigator.share({files:[this.#e]}))})}handleFile(t){this.#e=t,this.#n&&(this.#n.textContent=`${t.name} \xB7 ${u(t.size)}`),this.#o&&(this.#t&&URL.revokeObjectURL(this.#t),this.#t=URL.createObjectURL(t),this.#o.href=this.#t,this.#o.download=t.name)}static fromOutputControls(t){let o=t?.querySelector(".download");return o&&!(o instanceof HTMLAnchorElement)&&(console.warn(o,"is not an <a> element"),o=null),new e({fileName:t?.querySelector(".file-name"),downloadLink:o,copyButton:t?.querySelector(".icon-copy"),shareButton:t?.querySelector(".icon-share")})}};var p=class{lastValue;dependents=[];handleValue(t){this.lastValue=t;for(let o of this.dependents)o(t)}};var i={};function x(e){if(!(e instanceof HTMLElement&&e.dataset.ignore))if(e instanceof HTMLInputElement)if(i[e.name]??=new p,e.type==="number"||e.type==="range"||e.inputMode==="numeric"){if(e.value==="")return;i[e.name].handleValue(+e.value);let t=e.closest(".range-wrapper");if(t){let o=e;if(e.type==="range"){let a=t.lastElementChild;a instanceof HTMLInputElement&&(a.value=e.step==="any"||e.step&&+e.step<.1?(+e.value).toFixed(2):e.value)}else{let a=t.querySelector('[type="range"]');if(a instanceof HTMLInputElement)o=a;else return;o.value=e.value}let r=(+e.value-+o.min)/(+o.max-+o.min);o.style.setProperty("--progress",`${r*100}%`)}}else e.type==="checkbox"?i[e.name].handleValue(e.checked):e.type==="file"?e.files&&e.files.length>0&&i[e.name].handleValue(Array.from(e.files)):e.type==="radio"?e.checked&&i[e.name].handleValue(e.value):i[e.name].handleValue(e.value);else(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(i[e.name]??=new p,i[e.name].handleValue(e.value))}for(let e of document.getElementsByClassName("reform:image-input"))e instanceof HTMLInputElement&&(i[e.name]??=new p,w(i[e.name],e));for(let e of document.getElementsByClassName("reform:text-input"))e instanceof HTMLInputElement&&(i[e.name]??=new p,k(i[e.name],e));for(let e of document.getElementsByClassName("reform:file-input"))e instanceof HTMLInputElement&&(i[e.name]??=new p,v(i[e.name],e));for(let e of document.forms)for(let t of e.elements)x(t);document.addEventListener("input",e=>x(e.target));document.addEventListener("change",e=>x(e.target));function z(e,t){let o=typeof e=="string"?e:e.name;i[o]??=new p;let r=document.getElementById(o);if(!r){let l=document.getElementsByName(o);l.length>1&&console.warn("More than one element with name",o,Array.from(l)),r=l[0]??null}let a=typeof e!="string"&&e.deps||r?.dataset.deps?.split(" ")||[],s={},n=r instanceof HTMLCanvasElement?r.getContext("2d"):r,d=r?.closest(".reform\\:io")?.querySelector(".output-controls");if(d){let l=h.fromOutputControls(d);i[o].dependents.push(f=>l.handleFile(f))}let c=async()=>{if(g.size===a.length){let l=await t(n,s);i[o].handleValue(l)}},g=new Set;for(let l of a)i[l]??=new p,i[l].lastValue!==void 0&&(s[l]=i[l].lastValue,g.add(l)),i[l].dependents.push(f=>{s[l]=f,g.add(l),c()});c()}export{z as on};
